<?php
//require_once 'users/models.php';
//require_once 'groups/models.php';

function admin_page($id)
{
    $user = User::fetch($id);
    if(!$user) throw new NotFoundException();
    $groups = Group::all();
    $group_summary = Group::summary();

    // a strange bug insert a row on empty group list
    // so this clear the array if there is no groups
    if($group_summary['nb_groups'] == 0)
    {
        $groups = array();
    }
    $group_summary['sum_size'] = (int) $group_summary['sum_size'];

    //return "page de l'invite $user_id";
    return render('admin_page.tpl',compact('user','groups','group_summary'));
}

function edit($id)
{
    $user = fetch_or_404('User',$id);
    if($user->type != 'A')
    { throw new NotFoundException(); }

    if(is_post())
    {
        $user = User::update_from_post($user);

        $duplicate_email = User::email_exist($user->login_email,$user->id);
        if($user->isValid() && !$duplicate_email)
        {
            $user->save();
            return redirect('/organisateur/'.$user->id);
        } else {
            $message_type = 'error';
            $message = "Donnees invalides, impossible de creer l'enregistrement<br/>";
            $message .= $user->getErrorStackAsString();
            if($duplicate_email){
                $message .= '<br/>cet Email est deja present dans la base de donn&eacute;e';
            }
        }
    }

    return render('admin_edit.tpl',compact('user','message','message_type'));
}

